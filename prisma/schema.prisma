generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                 String              @id @default(uuid())
  name               String
  slug               String              @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  address            String?
  contactUserId      String?
  description        String?
  email              String?
  facebook           String?
  instagram          String?
  linkedin           String?
  phone              String?
  twitter            String?
  website            String?
  latitude           Float?
  longitude          Float?
  tiktok             String?
  smtpFromEmail      String?
  smtpFromName       String?
  smtpHost           String?
  smtpPassword       String?
  smtpPort           Int?
  smtpUser           String?
  language           String?             @default("en")
  creditPrice        Float?
  currency           String?             @default("USD")
  pricePeriodEnd     DateTime?
  pricePeriodStart   DateTime?
  defaultLocationId  String?
  bankAccountName    String?
  bankName           String?
  bankAccountNumber  String?
  bankIban           String?
  bankSwift          String?
  bankBranch         String?
  bookings           Booking[]
  classes            Class[]
  contactSubmissions ContactSubmission[]
  coupons            Coupon[]
  creditTransactions CreditTransaction[]
  instructors        Instructor[]
  locations          Location[]
  members            Member[]
  contactUser        User?               @relation("OrganizationContact", fields: [contactUserId], references: [id])
  defaultLocation    Location?           @relation("OrganizationDefaultLocation", fields: [defaultLocationId], references: [id])
  packageRedemptions PackageRedemption[]
  packages           Package[]
  priceHistory       PriceHistory[]
  sessions           Session[]
  users              User[]

  @@index([slug])
  @@index([contactUserId])
  @@map("organizations")
}

model User {
  id                          String              @id @default(uuid())
  supabaseUserId              String              @unique
  email                       String
  name                        String?
  role                        UserRole            @default(MEMBER)
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime            @updatedAt
  organizationId              String
  countryCode                 String?
  dateOfBirth                 DateTime?
  liabilityWaiverAccepted     Boolean             @default(false)
  liabilityWaiverAcceptedAt   DateTime?
  mobilePhone                 String?
  tocAccepted                 Boolean             @default(false)
  tocAcceptedAt               DateTime?
  bookings                    Booking[]
  performedCreditTransactions CreditTransaction[] @relation("CreditTransactionPerformedBy")
  instructor                  Instructor?
  memberships                 Member[]
  contactOrganizations        Organization[]      @relation("OrganizationContact")
  priceHistoryChanges         PriceHistory[]      @relation("PriceHistoryChangedBy")
  organization                Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([supabaseUserId])
  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Member {
  id                   String                @id @default(uuid())
  userId               String
  organizationId       String
  membershipType       String?
  status               MemberStatus          @default(ACTIVE)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  creditBalance        Float                 @default(0)
  isEliteMember        Boolean               @default(false)
  hasAllAccess         Boolean               @default(false)
  allAccessExpiresAt   DateTime?
  allAccessDailyUsages AllAccessDailyUsage[]
  bookings             Booking[]
  creditTransactions   CreditTransaction[]
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  packageRedemptions   PackageRedemption[]

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([isEliteMember])
  @@index([hasAllAccess])
  @@map("members")
}

model Instructor {
  id             String           @id @default(uuid())
  userId         String           @unique
  organizationId String
  bio            String?
  specialties    String[]
  status         InstructorStatus @default(ACTIVE)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  photoUrl       String?
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions       Session[]

  @@index([organizationId])
  @@index([userId])
  @@map("instructors")
}

model Class {
  id             String       @id @default(uuid())
  name           String
  description    String?
  organizationId String
  status         ClassStatus  @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  musicGenre     String?
  nameTr         String?
  descriptionTr  String?
  musicGenreTr   String?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions       Session[]

  @@index([organizationId])
  @@map("classes")
}

model Location {
  id                      String         @id @default(uuid())
  name                    String
  description             String?
  address                 String?
  organizationId          String
  isDefault               Boolean        @default(false)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  organization            Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  defaultForOrganizations Organization[] @relation("OrganizationDefaultLocation")
  seatLayouts             SeatLayout[]
  sessions                Session[]

  @@index([organizationId])
  @@index([isDefault])
  @@map("locations")
}

model SeatLayout {
  id          String   @id @default(uuid())
  locationId  String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  gridRows    Int?
  gridColumns Int?
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  seats       Seat[]

  @@index([locationId])
  @@index([isActive])
  @@map("seat_layouts")
}

model Seat {
  id           String     @id @default(uuid())
  seatLayoutId String
  seatNumber   String
  row          String?
  column       Int?
  type         SeatType   @default(NORMAL)
  creditCost   Int        @default(1)
  x            Float?
  y            Float?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  bookings     Booking[]
  seatLayout   SeatLayout @relation(fields: [seatLayoutId], references: [id], onDelete: Cascade)

  @@unique([seatLayoutId, seatNumber])
  @@index([seatLayoutId])
  @@index([type])
  @@index([isActive])
  @@map("seats")
}

model Session {
  id              String        @id @default(uuid())
  classId         String
  organizationId  String
  instructorId    String
  startTime       DateTime
  endTime         DateTime
  maxCapacity     Int
  currentBookings Int           @default(0)
  status          SessionStatus @default(SCHEDULED)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  locationId      String?
  duration        Int
  amPm            String
  bookings        Booking[]
  class           Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  instructor      Instructor    @relation(fields: [instructorId], references: [id])
  location        Location?     @relation(fields: [locationId], references: [id])
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([classId])
  @@index([locationId])
  @@index([instructorId])
  @@index([startTime])
  @@index([amPm])
  @@map("sessions")
}

model Booking {
  id                    String               @id @default(uuid())
  sessionId             String
  memberId              String
  userId                String
  organizationId        String
  status                BookingStatus        @default(CONFIRMED)
  checkedIn             Boolean              @default(false)
  checkedInAt           DateTime?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  creditCost            Int                  @default(1)
  seatId                String?
  paymentType           String?
  packageRedemptionId   String?
  creditsUsed           Int?
  allAccessDailyUsageId String?              @unique
  couponCode            String?
  allAccessDailyUsage   AllAccessDailyUsage?
  member                Member               @relation(fields: [memberId], references: [id], onDelete: Cascade)
  organization          Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  packageRedemption     PackageRedemption?   @relation("PackageRedemptionBookings", fields: [packageRedemptionId], references: [id])
  seat                  Seat?                @relation(fields: [seatId], references: [id])
  session               Session              @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  friendPassRedemption  PackageRedemption?   @relation("FriendPassBooking")

  @@unique([sessionId, memberId])
  @@index([organizationId])
  @@index([sessionId])
  @@index([memberId])
  @@index([userId])
  @@index([seatId])
  @@index([paymentType])
  @@index([packageRedemptionId])
  @@map("bookings")
}

model CreditTransaction {
  id                String                @id @default(uuid())
  memberId          String
  organizationId    String
  amount            Float
  balanceBefore     Float
  balanceAfter      Float
  type              CreditTransactionType
  description       String?
  performedByUserId String?
  createdAt         DateTime              @default(now())
  member            Member                @relation(fields: [memberId], references: [id], onDelete: Cascade)
  organization      Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  performedBy       User?                 @relation("CreditTransactionPerformedBy", fields: [performedByUserId], references: [id])

  @@index([organizationId])
  @@index([memberId])
  @@index([createdAt])
  @@index([type])
  @@map("credit_transactions")
}

model PriceHistory {
  id                String       @id @default(uuid())
  organizationId    String
  creditPriceBefore Float?
  creditPriceAfter  Float
  currencyBefore    String?
  currencyAfter     String
  changedByUserId   String?
  reason            String?
  createdAt         DateTime     @default(now())
  effectiveFrom     DateTime     @default(now())
  effectiveUntil    DateTime?
  changedBy         User?        @relation("PriceHistoryChangedBy", fields: [changedByUserId], references: [id])
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([createdAt])
  @@index([effectiveFrom])
  @@index([effectiveUntil])
  @@index([changedByUserId])
  @@map("price_history")
}

model Package {
  id                 String              @id @default(uuid())
  organizationId     String
  code               String              @unique
  name               String
  nameTr             String?
  type               PackageType
  price              Float
  credits            Int?
  pricePerCredit     Float?
  basePrice          Float?
  discountAmount     Float?
  discountPercentage Float?
  description        String?
  descriptionTr      String?
  benefits           Json?
  validFrom          DateTime?
  validUntil         DateTime?
  isActive           Boolean             @default(true)
  displayOrder       Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  coupons            Coupon[]
  packageRedemptions PackageRedemption[]
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([code])
  @@index([type])
  @@index([isActive])
  @@map("packages")
}

model Coupon {
  id                      String              @id @default(uuid())
  organizationId          String
  code                    String              @unique
  name                    String
  nameTr                  String?
  description             String?
  descriptionTr           String?
  couponType              CouponType
  packageId               String?
  customPrice             Float?
  customCredits           Int?
  discountType            DiscountType?
  discountValue           Float?
  applicablePackageIds    String[]
  bonusCredits            Int?
  validFrom               DateTime?
  validUntil              DateTime?
  maxRedemptions          Int?
  maxRedemptionsPerMember Int                 @default(1)
  isActive                Boolean             @default(true)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  organization            Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  package                 Package?            @relation(fields: [packageId], references: [id])
  packageRedemptions      PackageRedemption[]

  @@index([organizationId])
  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model PackageRedemption {
  id                   String                @id @default(uuid())
  memberId             String
  organizationId       String
  packageId            String?
  couponId             String?
  redemptionType       RedemptionType
  redeemedAt           DateTime              @default(now())
  redeemedBy           String?
  originalPrice        Float
  discountAmount       Float                 @default(0)
  finalPrice           Float
  creditsAdded         Int?
  allAccessExpiresAt   DateTime?
  allAccessDays        Int?
  friendPassAvailable  Boolean               @default(false)
  friendPassExpiresAt  DateTime?
  friendPassUsed       Boolean               @default(false)
  friendPassUsedAt     DateTime?
  friendPassBookingId  String?               @unique
  status               RedemptionStatus      @default(PENDING)
  notes                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  allAccessDailyUsages AllAccessDailyUsage[]
  bookings             Booking[]             @relation("PackageRedemptionBookings")
  coupon               Coupon?               @relation(fields: [couponId], references: [id])
  friendPassBooking    Booking?              @relation("FriendPassBooking", fields: [friendPassBookingId], references: [id])
  member               Member                @relation(fields: [memberId], references: [id], onDelete: Cascade)
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  package              Package?              @relation(fields: [packageId], references: [id])

  @@index([organizationId])
  @@index([memberId])
  @@index([packageId])
  @@index([couponId])
  @@index([status])
  @@index([allAccessExpiresAt])
  @@index([friendPassExpiresAt])
  @@map("package_redemptions")
}

model AllAccessDailyUsage {
  id                  String            @id @default(uuid())
  packageRedemptionId String
  memberId            String
  usageDate           DateTime          @db.Date
  bookingId           String?           @unique
  wasNoShow           Boolean           @default(false)
  createdAt           DateTime          @default(now())
  booking             Booking?          @relation(fields: [bookingId], references: [id])
  member              Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
  packageRedemption   PackageRedemption @relation(fields: [packageRedemptionId], references: [id], onDelete: Cascade)

  @@unique([packageRedemptionId, usageDate])
  @@index([memberId])
  @@index([usageDate])
  @@map("all_access_daily_usage")
}

model ContactSubmission {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  email          String
  phone          String?
  message        String
  status         ContactStatus @default(NEW)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([status])
  @@map("contact_submissions")
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  MEMBER
  TENANT_ADMIN
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum InstructorStatus {
  ACTIVE
  INACTIVE
}

enum ClassStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum SeatType {
  NORMAL
  EXCLUSIVE
  INSTRUCTOR
  PODIUM
  ARCHITECTURAL_COLUMN
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum CreditTransactionType {
  MANUAL_ADD
  MANUAL_DEDUCT
  BOOKING_PAYMENT
  REFUND
  ADJUSTMENT
}

enum PackageType {
  SINGLE_RIDE
  CREDIT_PACK
  ELITE_30
  ALL_ACCESS
}

enum CouponType {
  DISCOUNT
  PACKAGE
  CREDIT_BONUS
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum RedemptionType {
  PACKAGE_DIRECT
  COUPON_PACKAGE
  COUPON_DISCOUNT
}

enum RedemptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  USED
  PENDING
}

enum ContactStatus {
  NEW
  READ
  RESPONDED
  ARCHIVED
}
